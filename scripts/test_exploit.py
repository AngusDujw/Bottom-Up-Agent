import yaml

from BottomUpAgent.BottomUpAgent import SuperGamer


def test_run(config):
    gamer = SuperGamer(config)
    task = 'PlayGame and win the game'
    state = gamer.get_state()
    existed_object_ids = gamer.get_existed_object_ids(state)
    if len(existed_object_ids) == 0:
        return 'CallUser'

    potential_actions = gamer.get_potential_actions(state, existed_object_ids)
    action_id = gamer.brain.select_action(task, state, potential_actions)
    action = gamer.brain.long_memory.get_action(action_id)
    print(f"selected action name: {action['name']} description: {action['description']}")
    action_embedding = gamer.detector.encode_text(action['description'])
    action_description = action['description']
    action_knowledge = gamer.brain.get_action_knowledge(state, action_embedding, action_description)
    action_node = gamer.brain.select_action_node(action_knowledge)
    result, action_node = gamer.exploit(task, state, action_node)
    gamer.brain.update_action_knowledge(action_knowledge, action_node)  

if __name__ == "__main__":
    with open("config.yaml", "r") as f:
        config = yaml.load(f, Loader=yaml.FullLoader)
    test_run(config=config)